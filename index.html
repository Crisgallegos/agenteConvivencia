<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Apoyo a la Convivencia Escolar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 800px;
            margin-top: 50px;
            margin-bottom: 50px;
        }
        .card {
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 15px;
        }
        .card-header {
            background-color: #007bff;
            color: white;
            border-bottom: none;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            font-size: 1.5rem;
            text-align: center;
            padding: 1.5rem;
        }
        .form-label {
            font-weight: 600;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
            font-weight: 600;
            padding: 10px 20px;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }
        .resultados-container {
            margin-top: 20px;
        }
        #sugerenciaIA {
            padding: 20px;
            border-radius: 10px;
            background-color: #e9ecef;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="card-header">
            Sistema de Apoyo a la Convivencia Escolar
        </div>
        <div class="card-body p-4">
            <form id="formularioIncidente">
                <div class="mb-3">
                    <label for="nombreAlumno" class="form-label">Nombre del Alumno</label>
                    <input type="text" class="form-control" id="nombreAlumno" placeholder="Ej: Juan Pérez" required>
                </div>
                <div class="mb-3">
                    <label for="cursoAlumno" class="form-label">Curso</label>
                    <select class="form-select" id="cursoAlumno" required>
                        <option value="">Seleccione el curso</option>
                        <option value="1 básico">1° Básico</option>
                        <option value="2 básico">2° Básico</option>
                        <option value="3 básico">3° Básico</option>
                        <option value="4 básico">4° Básico</option>
                        <option value="5 básico">5° Básico</option>
                        <option value="6 básico">6° Básico</option>
                        <option value="7 básico">7° Básico</option>
                        <option value="8 básico">8° Básico</option>
                        <option value="1 medio">1° Medio</option>
                        <option value="2 medio">2° Medio</option>
                        <option value="3 medio">3° Medio</option>
                        <option value="4 medio">4° Medio</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="descripcionIncidente" class="form-label">Descripción del Incidente</label>
                    <textarea class="form-control" id="descripcionIncidente" rows="5" placeholder="Describe detalladamente lo sucedido..." required></textarea>
                </div>
                <button type="submit" class="btn btn-primary w-100">Analizar Caso</button>
            </form>

            <div id="resultados" class="resultados-container" style="display:none;">
                <hr>
                <h5>Resultado del Análisis de la IA</h5>
                <pre id="sugerenciaIA"></pre>

                <form id="formularioGuardar">
                    <div class="mb-3">
                        <label for="decisionFinal" class="form-label">Decisión Final</label>
                        <textarea class="form-control" id="decisionFinal" rows="3" placeholder="Confirma o modifica la sanción sugerida..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Guardar en el Historial</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    const appScriptUrl = 'https://script.google.com/macros/s/AKfycbx2xLkEkX2xeRivGq6YPtK45oYOw2QTRzHNAynEbLwO0VqdndmoOy9hednk1lM04E3k/exec';

    // Función para manejar el envío del formulario de "Analizar Caso"
    document.getElementById('formularioIncidente').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const nombreAlumno = document.getElementById('nombreAlumno').value;
        const cursoAlumno = document.getElementById('cursoAlumno').value;
        const descripcion = document.getElementById('descripcionIncidente').value;
        const resultadosDiv = document.getElementById('resultados');
        const sugerenciaIA = document.getElementById('sugerenciaIA');
        const decisionFinal = document.getElementById('decisionFinal');

        // Muestra un mensaje de carga
        sugerenciaIA.textContent = "Analizando el caso con la IA... por favor, espera.";
        resultadosDiv.style.display = 'block';

        const formData = new FormData();
        formData.append('action', 'analizar');
        formData.append('nombreAlumno', nombreAlumno);
        formData.append('cursoAlumno', cursoAlumno);
        formData.append('descripcionIncidente', descripcion);

        try {
            const response = await fetch(appScriptUrl, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.resultado === 'éxito') {
                // AHORA LA RESPUESTA DE LA IA ES UN OBJETO JSON
                const iaResultados = data.respuestaIA;

                // Mostramos un resumen de la IA en la página
                sugerenciaIA.textContent = `Falta: ${iaResultados.falta}\nArtículo: ${iaResultados.articulo}\nSanción: ${iaResultados.sancion}`;
                
                // Guardamos la sugerencia de sanción en el campo oculto
                decisionFinal.value = iaResultados.sancion;

            } else {
                throw new Error(data.mensaje);
            }
        } catch (error) {
            console.error('Error:', error);
            sugerenciaIA.textContent = "Error al analizar el caso. Por favor, revisa tu conexión o el script de Google Apps.";
        }
    });

    // Función para manejar el envío del formulario de "Guardar en el Historial"
    document.getElementById('formularioGuardar').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const nombreAlumno = document.getElementById('nombreAlumno').value;
        const cursoAlumno = document.getElementById('cursoAlumno').value;
        const descripcion = document.getElementById('descripcionIncidente').value;
        const sugerenciaIA = document.getElementById('sugerenciaIA').textContent;
        const decisionFinal = document.getElementById('decisionFinal').value;
        
        const formData = new FormData();
        formData.append('action', 'guardar');
        formData.append('nombreAlumno', nombreAlumno);
        formData.append('cursoAlumno', cursoAlumno);
        formData.append('descripcionIncidente', descripcion);
        formData.append('sugerenciaIA', sugerenciaIA);
        formData.append('decisionFinal', decisionFinal);

        try {
            const response = await fetch(appScriptUrl, {
                method: 'POST',
                body: formData
            });
            const data = await response.json();

            if (data.resultado === 'éxito') {
                alert('¡Éxito! El caso ha sido guardado en el historial.');
                document.getElementById('formularioIncidente').reset();
                document.getElementById('formularioGuardar').reset();
                document.getElementById('resultados').style.display = 'none';
            } else {
                throw new Error(data.mensaje);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Hubo un error de conexión al guardar.');
        }
    });
</script>

</body>
</html>

